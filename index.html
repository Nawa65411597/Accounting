import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAnalytics } from "firebase/analytics"; // เพิ่ม Import analytics
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  orderBy, 
  onSnapshot, 
  updateDoc, 
  deleteDoc, 
  doc, 
  setDoc,
  getDoc,
  serverTimestamp,
  where
} from 'firebase/firestore';
import { 
  PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer 
} from 'recharts';
import { 
  LayoutDashboard, 
  PlusCircle, 
  FileText, 
  CheckCircle, 
  XCircle, 
  Wallet, 
  TrendingUp, 
  TrendingDown, 
  AlertCircle,
  UserCog,
  Save,
  Clock,
  Edit2,
  Trash2,
  Filter,
  Calendar,
  X,
  LogOut,
  Lock,
  User
} from 'lucide-react';

// --- Firebase Configuration ---
// ใช้ Config ที่คุณระบุมา
const firebaseConfig = {
  apiKey: "AIzaSyDeplAebrKg4DE4LzlEK-_mM5vzSXm6LHo",
  authDomain: "accounting-fce01.firebaseapp.com",
  projectId: "accounting-fce01",
  storageBucket: "accounting-fce01.firebasestorage.app",
  messagingSenderId: "845580413748",
  appId: "1:845580413748:web:795e6d2e0174fba30dd361",
  measurementId: "G-ZQC35SZPZ6"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app); // Initialize Analytics
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants ---
const CATEGORIES = [
  'เงินเดือน', 'ค่าเช่า', 'อุปกรณ์สำนักงาน', 'ค่าเดินทาง', 
  'อาหาร', 'การตลาด', 'สาธารณูปโภค', 'รายได้จากการขาย', 'รายได้บริการ', 'อื่นๆ'
];

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658'];

// --- Helper Functions ---
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('th-TH', { 
    style: 'currency', 
    currency: 'THB' 
  }).format(amount);
};

const formatDate = (timestamp) => {
  if (!timestamp) return '-';
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  return new Intl.DateTimeFormat('th-TH', {
    day: 'numeric', month: 'short', year: '2-digit',
    hour: '2-digit', minute: '2-digit'
  }).format(date);
};

// --- Sub-Components ---

// Toast Notification
const ToastContainer = ({ toasts, removeToast }) => {
  return (
    <div className="fixed bottom-4 right-4 z-50 space-y-2 pointer-events-none">
      {toasts.map(toast => (
        <div 
          key={toast.id} 
          className={`flex items-center p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 pointer-events-auto ${
            toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'
          }`}
        >
          {toast.type === 'success' ? <CheckCircle size={20} className="mr-2"/> : <AlertCircle size={20} className="mr-2"/>}
          <span className="text-sm font-medium">{toast.message}</span>
          <button onClick={() => removeToast(toast.id)} className="ml-4 opacity-70 hover:opacity-100">
            <X size={16} />
          </button>
        </div>
      ))}
    </div>
  );
};

// Login/Register Screen
const LoginScreen = ({ onLogin, loading }) => {
  const [name, setName] = useState('');
  const [role, setRole] = useState('creator');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!name.trim()) return;
    onLogin(name, role);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
        <div className="text-center">
          <div className="bg-teal-100 p-3 rounded-full inline-flex mb-4">
            <Lock className="text-teal-600 w-8 h-8" />
          </div>
          <h2 className="text-2xl font-bold text-gray-900">เข้าสู่ระบบ / ลงทะเบียน</h2>
          <p className="text-gray-500 mt-2 text-sm">กำหนดชื่อและสิทธิ์การใช้งานสำหรับ Session นี้</p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้งาน</label>
            <div className="relative">
              <User className="absolute left-3 top-3 text-gray-400 w-5 h-5" />
              <input
                type="text"
                required
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="pl-10 w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border"
                placeholder="ระบุชื่อของคุณ"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">เลือกตำแหน่ง (Role)</label>
            <div className="grid grid-cols-2 gap-3">
              <button
                type="button"
                onClick={() => setRole('creator')}
                className={`flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all ${
                  role === 'creator' 
                  ? 'border-teal-500 bg-teal-50 text-teal-700' 
                  : 'border-gray-200 hover:border-gray-300 text-gray-600'
                }`}
              >
                <PlusCircle className="mb-2 w-6 h-6" />
                <span className="font-bold text-sm">Creator</span>
                <span className="text-xs mt-1 text-center opacity-80">ผู้บันทึกรายการ</span>
              </button>
              <button
                type="button"
                onClick={() => setRole('auditor')}
                className={`flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all ${
                  role === 'auditor' 
                  ? 'border-amber-500 bg-amber-50 text-amber-700' 
                  : 'border-gray-200 hover:border-gray-300 text-gray-600'
                }`}
              >
                <CheckCircle className="mb-2 w-6 h-6" />
                <span className="font-bold text-sm">Auditor</span>
                <span className="text-xs mt-1 text-center opacity-80">ผู้ตรวจสอบ</span>
              </button>
            </div>
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 transition-all"
          >
            {loading ? 'กำลังเข้าสู่ระบบ...' : 'เข้าสู่ระบบ'}
          </button>
        </form>
        
        <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700">
          <strong>หมายเหตุ:</strong> ระบบจะจดจำสิทธิ์ของคุณผ่านบัญชีนี้ (Firestore User Profile)
        </div>
      </div>
    </div>
  );
};

// Dashboard
const Dashboard = ({ transactions }) => {
  const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
  const [filterYear, setFilterYear] = useState(new Date().getFullYear());

  const filteredTransactions = useMemo(() => {
    return transactions.filter(t => {
      if (!t.date && !t.createdAt) return false;
      const date = t.date ? new Date(t.date) : t.createdAt.toDate();
      return date.getMonth() === filterMonth && date.getFullYear() === filterYear;
    });
  }, [transactions, filterMonth, filterYear]);

  const stats = useMemo(() => {
    let income = 0;
    let expense = 0;
    let pendingCount = 0;
    const categoryData = {};

    filteredTransactions.forEach(t => {
      if (t.status === 'approved') {
        if (t.type === 'income') {
          income += Number(t.amount);
        } else {
          expense += Number(t.amount);
          categoryData[t.category] = (categoryData[t.category] || 0) + Number(t.amount);
        }
      } 
    });

    pendingCount = transactions.filter(t => t.status === 'pending').length;

    const pieData = Object.keys(categoryData).map(key => ({
      name: key,
      value: categoryData[key]
    }));

    return { income, expense, balance: income - expense, pendingCount, pieData };
  }, [filteredTransactions, transactions]);

  return (
    <div className="space-y-6">
      <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-wrap items-center justify-between gap-4">
        <h3 className="text-lg font-bold text-gray-800 flex items-center">
          <Calendar className="mr-2 text-teal-600" size={20} /> ประจำเดือน
        </h3>
        <div className="flex space-x-2">
          <select 
            value={filterMonth} 
            onChange={(e) => setFilterMonth(parseInt(e.target.value))}
            className="rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 text-sm"
          >
            {['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'].map((m, i) => (
              <option key={i} value={i}>{m}</option>
            ))}
          </select>
          <select 
            value={filterYear} 
            onChange={(e) => setFilterYear(parseInt(e.target.value))}
            className="rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 text-sm"
          >
            {[2023, 2024, 2025, 2026].map(y => (
              <option key={y} value={y}>{y}</option>
            ))}
          </select>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
          <div>
            <span className="text-gray-500 text-sm font-medium">ยอดคงเหลือ (สุทธิ)</span>
            <div className={`text-2xl font-bold mt-1 ${stats.balance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
              {formatCurrency(stats.balance)}
            </div>
          </div>
          <div className="mt-2 flex items-center text-xs text-gray-400">
            <Wallet size={14} className="mr-1" /> Net Balance
          </div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
          <div>
            <span className="text-gray-500 text-sm font-medium">รายรับ (Approved)</span>
            <div className="text-2xl font-bold mt-1 text-green-600">{formatCurrency(stats.income)}</div>
          </div>
          <div className="mt-2 flex items-center text-xs text-gray-400">
            <TrendingUp size={14} className="mr-1" /> Income
          </div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
          <div>
            <span className="text-gray-500 text-sm font-medium">รายจ่าย (Approved)</span>
            <div className="text-2xl font-bold mt-1 text-red-600">{formatCurrency(stats.expense)}</div>
          </div>
          <div className="mt-2 flex items-center text-xs text-gray-400">
            <TrendingDown size={14} className="mr-1" /> Expense
          </div>
        </div>
        <div className="bg-amber-50 p-4 rounded-xl shadow-sm border border-amber-100 flex flex-col justify-between">
          <div>
            <span className="text-amber-800 text-sm font-medium">รอตรวจสอบ</span>
            <div className="text-2xl font-bold mt-1 text-amber-600">{stats.pendingCount} รายการ</div>
          </div>
          <div className="mt-2 flex items-center text-xs text-amber-700">
            <AlertCircle size={14} className="mr-1" /> Pending Review
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide">สัดส่วนค่าใช้จ่าย</h3>
          <div className="h-64 w-full">
             {stats.pieData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={stats.pieData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={80}
                      fill="#8884d8"
                      paddingAngle={5}
                      dataKey="value"
                    >
                      {stats.pieData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <RechartsTooltip formatter={(value) => formatCurrency(value)} />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
             ) : (
               <div className="h-full flex flex-col items-center justify-center text-gray-400">
                 <div className="bg-gray-100 p-4 rounded-full mb-2"><TrendingDown size={24}/></div>
                 ไม่มีข้อมูลรายจ่าย
               </div>
             )}
          </div>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide">กราฟเปรียบเทียบ</h3>
          <div className="h-64 w-full">
            {stats.income > 0 || stats.expense > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <BarChart
                  data={[
                    { name: 'รายรับ', amount: stats.income, fill: '#10B981' },
                    { name: 'รายจ่าย', amount: stats.expense, fill: '#EF4444' },
                    { name: 'คงเหลือ', amount: stats.balance, fill: '#3B82F6' },
                  ]}
                  margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                >
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E5E7EB" />
                  <XAxis dataKey="name" tickLine={false} axisLine={false} />
                  <YAxis tickFormatter={(val) => `฿${val/1000}k`} tickLine={false} axisLine={false} />
                  <RechartsTooltip 
                    cursor={{fill: '#F3F4F6'}}
                    formatter={(value) => formatCurrency(value)}
                  />
                  <Bar dataKey="amount" radius={[6, 6, 0, 0]} barSize={60} />
                </BarChart>
              </ResponsiveContainer>
            ) : (
               <div className="h-full flex flex-col items-center justify-center text-gray-400">
                 <div className="bg-gray-100 p-4 rounded-full mb-2"><Wallet size={24}/></div>
                 ไม่มีข้อมูล
               </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Transaction Form
const TransactionForm = ({ onSave, initialData, onCancel, submitting }) => {
  const [formData, setFormData] = useState({
    type: 'expense',
    amount: '',
    category: 'ทั่วไป',
    description: '',
    date: new Date().toISOString().slice(0, 10),
    ...initialData
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.amount || !formData.description) return;
    onSave({
      ...formData,
      amount: parseFloat(formData.amount)
    });
  };

  return (
    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
      <div className="flex justify-between items-center mb-6">
        <h3 className="text-lg font-bold text-gray-800 flex items-center">
          {initialData ? <Edit2 className="mr-2 text-blue-600" size={20} /> : <PlusCircle className="mr-2 text-teal-600" size={20} />}
          {initialData ? 'แก้ไขรายการ' : 'บันทึกรายการใหม่'}
        </h3>
        {initialData && (
          <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">
            <X size={20}/>
          </button>
        )}
      </div>
      
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">ประเภท</label>
            <div className="flex rounded-md shadow-sm" role="group">
              <button
                type="button"
                onClick={() => setFormData({...formData, type: 'income'})}
                className={`flex-1 px-4 py-2 text-sm font-medium rounded-l-lg border transition-colors ${
                  formData.type === 'income' 
                  ? 'bg-green-50 text-green-700 border-green-200 z-10' 
                  : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                }`}
              >
                รายรับ
              </button>
              <button
                type="button"
                onClick={() => setFormData({...formData, type: 'expense'})}
                className={`flex-1 px-4 py-2 text-sm font-medium rounded-r-lg border transition-colors ${
                  formData.type === 'expense' 
                  ? 'bg-red-50 text-red-700 border-red-200 z-10' 
                  : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                }`}
              >
                รายจ่าย
              </button>
            </div>
          </div>
          <div>
             <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">จำนวนเงิน</label>
             <input 
               type="number" 
               required
               min="0"
               step="0.01"
               value={formData.amount}
               onChange={e => setFormData({...formData, amount: e.target.value})}
               className="w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border text-right font-mono"
               placeholder="0.00"
             />
          </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">หมวดหมู่</label>
            <select
              value={formData.category}
              onChange={e => setFormData({...formData, category: e.target.value})}
              className="w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border"
            >
              {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
           <div>
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">วันที่รายการ</label>
            <input 
               type="date"
               value={formData.date}
               onChange={e => setFormData({...formData, date: e.target.value})}
               className="w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border"
            />
          </div>
        </div>

        <div>
          <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">รายละเอียด</label>
          <input 
            type="text"
            required
            value={formData.description}
            onChange={e => setFormData({...formData, description: e.target.value})}
            className="w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border"
            placeholder="อธิบายรายการ..."
          />
        </div>

        <div className="pt-4 flex space-x-3">
          {initialData && (
             <button 
             type="button" 
             onClick={onCancel}
             className="flex-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
           >
             ยกเลิก
           </button>
          )}
          <button 
            type="submit" 
            disabled={submitting}
            className="flex-1 flex justify-center items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 disabled:opacity-50 transition-colors"
          >
            {submitting ? 'กำลังบันทึก...' : <><Save size={18} className="mr-2"/> {initialData ? 'บันทึก' : 'บันทึกรายการ'}</>}
          </button>
        </div>
      </form>
    </div>
  );
};

// Approval List
const ApprovalList = ({ transactions, onApprove, onReject }) => {
  const pendingItems = transactions.filter(t => t.status === 'pending');

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div className="p-6 border-b border-gray-100 bg-amber-50 flex justify-between items-center">
        <div>
          <h3 className="text-lg font-bold text-amber-800 flex items-center">
            <AlertCircle className="mr-2" size={20} /> รอตรวจสอบ ({pendingItems.length})
          </h3>
          <p className="text-sm text-amber-600 mt-1">อนุมัติรายการเพื่อปรับปรุงยอดบัญชีจริง</p>
        </div>
      </div>

      {pendingItems.length === 0 ? (
        <div className="p-12 text-center text-gray-400 flex flex-col items-center">
          <div className="bg-gray-50 p-4 rounded-full mb-3"><CheckCircle size={32} className="text-green-500" /></div>
          <span className="font-medium">ไม่มีรายการค้างตรวจสอบ</span>
        </div>
      ) : (
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">วันที่</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">รายละเอียด</th>
                <th className="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">จำนวนเงิน</th>
                <th className="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">จัดการ</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {pendingItems.map((item) => (
                <tr key={item.id} className="hover:bg-gray-50 transition-colors">
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {formatDate(item.createdAt)}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-bold text-gray-900">{item.description}</div>
                    <div className="text-xs text-gray-500 flex items-center mt-1">
                      <span className={`inline-block w-2 h-2 rounded-full mr-1 ${item.type === 'income' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                      {item.category}
                      <span className="ml-2 text-gray-400">โดย {item.createdByName || 'ไม่ระบุ'}</span>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-bold">
                    <span className={item.type === 'income' ? 'text-green-600' : 'text-red-600'}>
                      {item.type === 'income' ? '+' : '-'}{formatCurrency(item.amount)}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                    <button onClick={() => onApprove(item.id)} className="px-3 py-1.5 rounded text-xs font-medium text-white bg-green-600 hover:bg-green-700 shadow-sm">อนุมัติ</button>
                    <button onClick={() => onReject(item.id)} className="px-3 py-1.5 rounded text-xs font-medium text-red-600 bg-white border border-gray-200 hover:bg-red-50 shadow-sm">ปฏิเสธ</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

// History Table
const TransactionHistory = ({ transactions, userProfile, onEdit, onDelete }) => {
  const [statusFilter, setStatusFilter] = useState('all');
  const [typeFilter, setTypeFilter] = useState('all');

  const filteredData = transactions.filter(t => {
    const statusMatch = statusFilter === 'all' || t.status === statusFilter;
    const typeMatch = typeFilter === 'all' || t.type === typeFilter;
    return statusMatch && typeMatch;
  });

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div className="p-5 border-b border-gray-100 flex flex-col md:flex-row justify-between md:items-center gap-4">
        <h3 className="text-lg font-bold text-gray-800 flex items-center">
          <FileText className="mr-2 text-gray-500" size={20} /> รายการเดินบัญชี
        </h3>
        
        <div className="flex space-x-2 text-sm">
          <select 
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="pl-2 pr-8 py-2 border border-gray-200 rounded-lg text-gray-600 focus:ring-teal-500"
          >
            <option value="all">สถานะ: ทั้งหมด</option>
            <option value="approved">Approved</option>
            <option value="pending">Pending</option>
            <option value="rejected">Rejected</option>
          </select>
          <select 
            value={typeFilter}
            onChange={(e) => setTypeFilter(e.target.value)}
            className="px-3 py-2 border border-gray-200 rounded-lg text-gray-600 focus:ring-teal-500"
          >
            <option value="all">ประเภท: ทั้งหมด</option>
            <option value="income">รายรับ</option>
            <option value="expense">รายจ่าย</option>
          </select>
        </div>
      </div>
      
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">สถานะ</th>
              <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">วันที่</th>
              <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">รายการ</th>
              <th className="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">จำนวนเงิน</th>
              {userProfile.role === 'creator' && <th className="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">จัดการ</th>}
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {filteredData.slice(0, 20).map((item) => (
              <tr key={item.id} className="hover:bg-gray-50 group">
                <td className="px-6 py-4 whitespace-nowrap">
                  {item.status === 'approved' && <span className="px-2.5 py-0.5 inline-flex text-xs font-medium rounded-full bg-green-100 text-green-800 border border-green-200">Approved</span>}
                  {item.status === 'pending' && <span className="px-2.5 py-0.5 inline-flex text-xs font-medium rounded-full bg-amber-100 text-amber-800 border border-amber-200">Pending</span>}
                  {item.status === 'rejected' && <span className="px-2.5 py-0.5 inline-flex text-xs font-medium rounded-full bg-red-100 text-red-800 border border-red-200">Rejected</span>}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                  {item.date || formatDate(item.createdAt)}
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="text-sm text-gray-900 font-medium">{item.description}</div>
                  <div className="text-xs text-gray-500">{item.category} <span className="text-gray-300">|</span> {item.createdByName}</div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-bold font-mono">
                   <span className={item.type === 'income' ? 'text-green-600' : 'text-red-600'}>
                      {item.type === 'income' ? '+' : '-'}{formatCurrency(item.amount)}
                    </span>
                </td>
                {userProfile.role === 'creator' && (
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    {/* Can edit only if owned by user AND (pending OR rejected) */}
                    {(item.createdBy === userProfile.uid && item.status !== 'approved') && (
                      <div className="flex justify-end space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onClick={() => onEdit(item)} className="text-blue-600 hover:text-blue-900 p-1 hover:bg-blue-50 rounded"><Edit2 size={16} /></button>
                        <button onClick={() => onDelete(item.id)} className="text-red-600 hover:text-red-900 p-1 hover:bg-red-50 rounded"><Trash2 size={16} /></button>
                      </div>
                    )}
                  </td>
                )}
              </tr>
            ))}
            {filteredData.length === 0 && (
               <tr><td colSpan={userProfile.role === 'creator' ? 5 : 4} className="text-center py-8 text-gray-400">ไม่พบรายการ</td></tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// --- Main Application ---
export default function AccountingApp() {
  const [user, setUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null); // { name, role, uid }
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('dashboard'); 
  const [toasts, setToasts] = useState([]);
  const [editingItem, setEditingItem] = useState(null);

  // Auth & Profile Init
  useEffect(() => {
    const init = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    init();

    const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        // Fetch User Profile
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', `user_${currentUser.uid}`);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          setUserProfile(userSnap.data());
        } else {
          setUserProfile(null); // Trigger Login Screen
        }
      }
      setLoading(false);
    });
    return () => unsubscribeAuth();
  }, []);

  // Fetch Transactions
  useEffect(() => {
    if (!user) return;
    const q = query(
      collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), 
      orderBy('createdAt', 'desc')
    );

    const unsubscribeData = onSnapshot(q, (snapshot) => {
      const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setTransactions(items);
    });

    return () => unsubscribeData();
  }, [user]);

  // Actions
  const addToast = (message, type = 'success') => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
  };

  const handleLogin = async (name, role) => {
    if (!user) return;
    setLoading(true);
    try {
      const profile = {
        uid: user.uid,
        name,
        role,
        createdAt: serverTimestamp()
      };
      // Save profile to public data so it persists for this demo
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `user_${user.uid}`), profile);
      setUserProfile(profile);
      setActiveTab('dashboard');
      addToast(`ยินดีต้อนรับคุณ ${name} (${role})`);
    } catch (err) {
      console.error(err);
      addToast("ลงทะเบียนไม่สำเร็จ", "error");
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = async () => {
    if(window.confirm("ต้องการออกจากระบบหรือไม่? (ข้อมูลบัญชีจะถูกรีเซ็ตในเครื่องนี้)")) {
      // For demo, we just clear local state to re-trigger login screen
      // In real app: signOut(auth);
      setUserProfile(null); 
      addToast("ออกจากระบบแล้ว");
    }
  };

  const handleAddTransaction = async (data) => {
    if (!user || !userProfile) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
        ...data,
        status: 'pending',
        createdAt: serverTimestamp(),
        createdBy: user.uid,
        createdByName: userProfile.name,
        updatedAt: serverTimestamp()
      });
      addToast("บันทึกสำเร็จ (รอตรวจสอบ)");
      setActiveTab('dashboard');
    } catch (err) {
      addToast("บันทึกผิดพลาด", "error");
    }
  };

  const handleUpdateTransaction = async (data) => {
    if (!editingItem) return;
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', editingItem.id), {
        ...data,
        status: 'pending', // Re-verify needed
        updatedAt: serverTimestamp()
      });
      addToast("แก้ไขเรียบร้อย (ส่งตรวจสอบใหม่)");
      setEditingItem(null);
    } catch (err) {
      addToast("แก้ไขผิดพลาด", "error");
    }
  };

  const handleDeleteTransaction = async (id) => {
    if(!window.confirm("ยืนยันการลบ?")) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id));
      addToast("ลบสำเร็จ", "success");
    } catch (err) {
      addToast("ลบผิดพลาด", "error");
    }
  };

  const handleApprove = async (id) => {
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), {
        status: 'approved',
        approvedAt: serverTimestamp(),
        approvedBy: user.uid,
        approvedByName: userProfile.name
      });
      addToast("อนุมัติแล้ว");
    } catch (err) {
      addToast("ผิดพลาด", "error");
    }
  };

  const handleReject = async (id) => {
    if(!window.confirm("ยืนยันการปฏิเสธรายการนี้?")) return;
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        rejectedBy: user.uid,
        rejectedByName: userProfile.name
      });
      addToast("ปฏิเสธแล้ว", "error");
    } catch (err) {
      addToast("ผิดพลาด", "error");
    }
  };

  // Loading Screen
  if (loading) return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 text-teal-600">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mb-4"></div>
      <p>กำลังเชื่อมต่อฐานข้อมูล...</p>
    </div>
  );

  // Login Screen
  if (!userProfile) {
    return <LoginScreen onLogin={handleLogin} loading={loading} />;
  }

  // Main App Interface
  return (
    <div className="min-h-screen bg-gray-50 text-gray-900 font-sans pb-10">
      <ToastContainer toasts={toasts} removeToast={(id) => setToasts(p => p.filter(t => t.id !== id))} />

      {/* Header */}
      <header className="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="bg-teal-600 p-2 rounded-lg text-white">
              <Wallet size={20} />
            </div>
            <div>
              <h1 className="text-lg font-bold tracking-tight text-gray-900">Accounting Pro</h1>
              <p className="text-xs text-gray-500">ระบบบัญชีออนไลน์</p>
            </div>
          </div>
          
          <div className="flex items-center space-x-4">
            <div className="text-right hidden sm:block">
              <div className="text-sm font-bold text-gray-900">{userProfile.name}</div>
              <div className="text-xs text-gray-500 uppercase tracking-wide">{userProfile.role}</div>
            </div>
            <button 
              onClick={handleLogout}
              className="p-2 text-gray-400 hover:text-red-600 transition-colors bg-gray-50 rounded-full hover:bg-red-50"
              title="ออกจากระบบ"
            >
              <LogOut size={20} />
            </button>
          </div>
        </div>
        
        {/* Navigation Tabs based on Role */}
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <nav className="-mb-px flex space-x-6 overflow-x-auto">
            <button
              onClick={() => setActiveTab('dashboard')}
              className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center ${
                activeTab === 'dashboard' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              <LayoutDashboard size={16} className="mr-2"/> ภาพรวม
            </button>
            
            {userProfile.role === 'creator' && (
              <button
                onClick={() => setActiveTab('entry')}
                className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center ${
                  activeTab === 'entry' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <PlusCircle size={16} className="mr-2"/> บันทึกรายการ
              </button>
            )}
            
            {userProfile.role === 'auditor' && (
              <button
                onClick={() => setActiveTab('approval')}
                className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center ${
                  activeTab === 'approval' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <AlertCircle size={16} className="mr-2"/> 
                รอตรวจสอบ ({transactions.filter(t=>t.status==='pending').length})
              </button>
            )}

            <button
              onClick={() => setActiveTab('report')}
              className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center ${
                activeTab === 'report' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              <FileText size={16} className="mr-2"/> ประวัติ/รายงาน
            </button>
          </nav>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {/* Edit Modal */}
        {editingItem && (
          <div className="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div className="w-full max-w-lg">
              <TransactionForm 
                initialData={editingItem} 
                onSave={handleUpdateTransaction} 
                onCancel={() => setEditingItem(null)}
              />
            </div>
          </div>
        )}

        <div className="animate-fade-in">
          {activeTab === 'dashboard' && <Dashboard transactions={transactions} />}
          
          {activeTab === 'entry' && userProfile.role === 'creator' && (
            <div className="max-w-2xl mx-auto">
              <div className="mb-4 p-4 bg-teal-50 text-teal-800 rounded-lg text-sm border border-teal-100 flex items-start">
                 <div className="mr-3 bg-teal-100 p-1.5 rounded-full"><PlusCircle size={16}/></div>
                 <div>
                   <span className="font-bold">โหมดบันทึกรายการ:</span> คุณกำลังบันทึกข้อมูลในนาม <u>{userProfile.name}</u> รายการจะถูกส่งไปตรวจสอบก่อน
                 </div>
              </div>
              <TransactionForm onSave={handleAddTransaction} />
            </div>
          )}
          
          {activeTab === 'approval' && userProfile.role === 'auditor' && (
            <ApprovalList transactions={transactions} onApprove={handleApprove} onReject={handleReject} />
          )}
          
          {activeTab === 'report' && (
            <TransactionHistory 
              transactions={transactions} 
              userProfile={userProfile}
              onEdit={setEditingItem}
              onDelete={handleDeleteTransaction}
            />
          )}
        </div>
      </main>
    </div>
  );
}
